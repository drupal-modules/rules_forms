# Travis CI build configuration config file.
language: php

python:
  - 5.6
# - 7

addons:
  hosts:
    - localhost
  apt:
    packages:
    # - drush # See: https://github.com/travis-ci/apt-package-whitelist/issues/1611
    - wget
    - realpath
    - tree
    - html2text

notifications:
  email:
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start:   never   # options: [always|never|change] default: always

# Environment
sudo: false
env:
  global:
    - URL="http://$HOSTNAME:8080/"
    - ROOT="$HOME/build/drupal"
    - DRUSH="drush -vy -l '$URL' -r '$ROOT'"
    - COMPOSER_BIN_DIR=~/bin
    - DB_URL="mysql://root:@localhost/drupal"
    - PATH=${PATH//:\.\/node_modules\/\.bin/} # Fixes Travis bug: https://github.com/travis-ci/travis-ci/issues/4862

  matrix:
    - CORE=7 TEST_MODULE="rules_forms"

mysql:
  database: drupal
  username: root
  encoding: utf8

before_install:
  - env
# - set -e # Fail build on first error.

install:
  - gem install mailcatcher && mailcatcher -v && echo 'sendmail_path="/usr/bin/env catchmail"' | tee -a "$(php --ini | grep "Loaded Configuration" | awk '{print $4}')"
  - composer global require -n --prefer-source drush/drush:dev-master drupal/coder && drush --version
  - $DRUSH -vy qd --no-server --watchdog --core=drupal-$CORE testsite
  - rsync -vuar "$TRAVIS_BUILD_DIR" "$ROOT"/sites/all/modules/contrib
  - $DRUSH en $TEST_MODULE
  - $DRUSH dis update
# - $DRUSH en simpletest

before_script:
  - $DRUSH -v rs $URL &
  - phpcs --config-set installed_paths ~/.composer/vendor/drupal/coder/coder_sniffer
  - html2text <(wget -O- --retry-connrefused $URL)
# - mysql -e 'create database drupal'

script:
  - phpcs -n --standard=Drupal,DrupalPractice --colors --extensions=php,module,inc,install,test,profile,theme,js,css,info,txt,md $(drush dd $TEST_MODULE)
  - $DRUSH core-requirements --severity=2 | grep -iw --color=auto error
  - phpunit -v "$ROOT"/sites/all
  - php "$ROOT"/scripts/run-tests.sh --color --url $URL --php "$(which php)" --file $(find "$ROOT"/sites/all/modules -name "*.test" | paste -d, -s)

after_success:
 - html2text <(curl http://localhost:1080)

after_failure:
 - $DRUSH status --full
 - $DRUSH core-requirements --severity=2
 - tree -d -L 6 ~/ # Print directory structure in the form of a tree.

after_script:
 - $DRUSH ws --full
 - html2text <(wget -qO- $URL)
